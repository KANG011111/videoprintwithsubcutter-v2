<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯å­—å¹•æˆªåœ–å·¥å…· - å…¨æ–°ç‰ˆæœ¬</title>
    <!-- å¼·åˆ¶ç¦ç”¨ç·©å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="style.css?v=<?php echo time(); ?>">
    <style>
        .mode3-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .mode-option {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .mode-option:hover {
            background-color: #f0f2f5;
        }
        
        .new-badge {
            background: #ff4757;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .card-title-editor {
            cursor: text;
        }
        
        .card-title-editor:hover {
            background-color: #f8f9fa !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
        }
        
        .card-title-editor:focus {
            box-shadow: 0 0 0 2px #e3f2fd !important;
        }

        /* æ¨™é¡Œå€åŸŸéš±è—æ¨£å¼ - Chrome 140+ å…¼å®¹æ€§ä¿®å¾© */
        .title-section.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden !important;
            max-height: 0 !important;
        }

        .title-section.visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            max-height: none !important;
        }
        
        .screenshot-number {
            position: absolute;
            top: -30px;
            left: 0;
            background: #2196f3;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
        }
    </style>
</head>
<body>
    <h1>ğŸ¬ å‰ç«¯å­—å¹•æˆªåœ–å·¥å…· <small style="color:#666;">(å«æ¨¡å¼3)</small></h1>

    <div class="main-container">
        <div class="left-panel">
            <div class="section" id="video-section">
                <h2>1. å½±ç‰‡å€</h2>
                <div class="input-group">
                    <label for="video-file-input">ä¸Šå‚³å½±ç‰‡æª” (MP4/WebM)</label>
                    <input type="file" id="video-file-input" accept="video/mp4,video/webm">
                </div>
                <video id="video-player" controls crossorigin="anonymous"></video>
            </div>

            <div class="section" id="subtitle-section">
                <h2>2. å­—å¹•å€</h2>
                <div class="input-group">
                    <label for="subtitle-file-input">ä¸Šå‚³å­—å¹•æª” (.srt / .vtt)</label>
                    <input type="file" id="subtitle-file-input" accept=".srt,.vtt">
                </div>
                <div id="subtitle-info"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="section" id="settings-section">
                <h2>3. æ“·å–è¨­å®š</h2>
                <div class="input-group">
                    <label for="start-time-input">èµ·å§‹æ™‚é–“ (hh:mm:ss)</label>
                    <input type="text" id="start-time-input" value="00:00:01">
                </div>
                <div class="input-group">
                    <label for="interval-input">æ“·å–é–“éš” (ç§’)</label>
                    <input type="number" id="interval-input" value="30" min="1">
                </div>
                <div class="input-group">
                    <label><strong>ğŸ“‹ æ¨¡å¼åˆ‡æ›</strong></label>
                    <div id="mode-switcher" style="border: 2px solid #e9ecef; border-radius: 12px; padding: 15px; background: #f8f9fa;">
                        <div class="mode-option">
                            <input type="radio" id="mode1" name="mode" value="1" checked>
                            <label for="mode1">ğŸ”¤ æ¨¡å¼ 1ï¼šç–ŠåŠ å­—å¹•</label>
                        </div>
                        <div class="mode-option">
                            <input type="radio" id="mode2" name="mode" value="2">
                            <label for="mode2">ğŸ“‘ æ¨¡å¼ 2ï¼šåˆ†æ¬„å­—å¹•</label>
                        </div>
                        <div class="mode-option" style="background: linear-gradient(135deg, #667eea20, #764ba220); border: 2px solid #667eea; border-radius: 8px;">
                            <input type="radio" id="mode3" name="mode" value="3">
                            <label for="mode3" class="mode3-highlight">
                                ğŸ¨ æ¨¡å¼ 3ï¼šæ–‡ç« å¡ç‰‡æ¨£å¼ 
                                <span class="new-badge">NEW</span>
                            </label>
                            <div style="font-size: 12px; color: #666; margin-top: 4px; margin-left: 20px;">
                                âœ¨ ç²¾ç¾å¡ç‰‡è¨­è¨ˆ | å¯ç·¨è¼¯å…§å®¹ | è‡ªå®šç¾©æ¨£å¼
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨¡å¼3å°ˆå±¬è¨­å®š -->
                <div id="mode3-settings" style="display:none;">
                    <div class="input-group">
                        <label for="card-title-input">ğŸ·ï¸ å¡ç‰‡æ¨™é¡Œ</label>
                        <input type="text" id="card-title-input" placeholder="è¼¸å…¥è‡ªå®šç¾©æ¨™é¡Œ..." value="ChatGPT æœå°‹æç¤º">
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ğŸ’¡ æç¤ºï¼šç•™ç©ºå‰‡ä¸é¡¯ç¤ºæ¨™é¡Œå’Œæ©«ç·š
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="theme-color-input">ğŸ¨ ä¸»é¡Œè‰²å½©</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="theme-color-input" value="#1877f2">
                            <span id="color-preview" style="font-size: 12px; color: #1877f2;">#1877f2</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="title-font-size-input">ğŸ“ æ¨™é¡Œå­—é«”å¤§å°: <span id="title-font-size-display">22px</span></label>
                        <input type="range" id="title-font-size-input" min="18" max="28" value="22">
                    </div>
                    <div class="input-group">
                        <label for="content-font-size-input">ğŸ“„ å…§å®¹å­—é«”å¤§å°: <span id="content-font-size-display">16px</span></label>
                        <input type="range" id="content-font-size-input" min="14" max="20" value="16">
                    </div>
                </div>
                
                <button id="capture-btn">ğŸ“¸ æ“·å–æˆªåœ–</button>
            </div>

            <div class="section" id="output-section">
                <h2>4. è¼¸å‡ºå€</h2>
                <button id="download-all-zip-btn" style="display:none; margin-bottom: 15px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">ğŸ“¦ ä¸€éµæ‰“åŒ…å…¨éƒ¨åœ–ç‰‡ (ZIP)</button>
                <div id="batch-progress"></div>
                <div id="output-preview"></div>
                <button id="download-btn" style="display:none;">â¬‡ï¸ ä¸‹è¼‰é¸ä¸­åœ–ç‰‡</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // åœ¨é é¢è¼‰å…¥æ™‚ç«‹å³é¡¯ç¤ºæ¨¡å¼3ç¢ºèª
        window.addEventListener('load', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œæª¢æŸ¥æ¨¡å¼3...');
            const mode3Radio = document.getElementById('mode3');
            const mode3Label = document.querySelector('label[for="mode3"]');
            
            if (mode3Radio && mode3Label) {
                console.log('âœ… æ¨¡å¼3å…ƒç´ æ‰¾åˆ°äº†ï¼');
                alert('ğŸ‰ æˆåŠŸï¼æ¨¡å¼3å·²è¼‰å…¥ä¸¦å¯è¦‹ï¼\n\nè«‹é¸æ“‡æ¨¡å¼3ä¾†é«”é©—æ–°åŠŸèƒ½ã€‚');
            } else {
                console.error('âŒ æ¨¡å¼3å…ƒç´ æœªæ‰¾åˆ°ï¼');
                alert('âŒ éŒ¯èª¤ï¼šæ¨¡å¼3æœªæ­£ç¢ºè¼‰å…¥ï¼');
            }
        });

        let subtitles = [];
        let videoFileName = '';
        let subtitleFileName = '';
        let imageCounter = 0; // å…¨å±€åœ–ç‰‡è¨ˆæ•¸å™¨ï¼ŒæŒ‰ç”Ÿæˆé †åºç·¨è™Ÿ

        const videoFileInput = document.getElementById('video-file-input');
        const videoPlayer = document.getElementById('video-player');
        const subtitleFileInput = document.getElementById('subtitle-file-input');
        const subtitleInfo = document.getElementById('subtitle-info');
        const startTimeInput = document.getElementById('start-time-input');
        const intervalInput = document.getElementById('interval-input');
        const mode1Radio = document.getElementById('mode1');
        const mode2Radio = document.getElementById('mode2');
        const mode3Radio = document.getElementById('mode3');
        const mode3Settings = document.getElementById('mode3-settings');
        const cardTitleInput = document.getElementById('card-title-input');
        const themeColorInput = document.getElementById('theme-color-input');
        const titleFontSizeInput = document.getElementById('title-font-size-input');
        const contentFontSizeInput = document.getElementById('content-font-size-input');
        const titleFontSizeDisplay = document.getElementById('title-font-size-display');
        const contentFontSizeDisplay = document.getElementById('content-font-size-display');
        const colorPreview = document.getElementById('color-preview');
        const captureBtn = document.getElementById('capture-btn');
        const batchProgress = document.getElementById('batch-progress');
        const outputPreview = document.getElementById('output-preview');
        const downloadBtn = document.getElementById('download-btn');
        const downloadAllZipBtn = document.getElementById('download-all-zip-btn');

        videoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                videoFileName = file.name.split('.').slice(0, -1).join('.') || 'video';
                videoPlayer.src = URL.createObjectURL(file);
                console.log('å½±ç‰‡å·²è¼‰å…¥:', videoFileName);
            }
        });

        subtitleFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // ä¿å­˜å­—å¹•æª”åï¼ˆå»é™¤å‰¯æª”åï¼‰
                subtitleFileName = file.name.split('.').slice(0, -1).join('.') || 'subtitles';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    console.log('å­—å¹•æª”å…§å®¹å‰100å­—:', content.substring(0, 100));
                    subtitles = parseSrt(content);
                    console.log('è§£æå¾Œå­—å¹•:', subtitles.slice(0, 3));
                    subtitleInfo.textContent = `å·²è¼‰å…¥: ${file.name} (${subtitles.length} æ¢å­—å¹•)`;
                };
                reader.readAsText(file);
            }
        });

        // æ¨¡å¼åˆ‡æ›äº‹ä»¶ç›£è½å™¨
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                mode3Settings.style.display = mode3Radio.checked ? 'block' : 'none';
            });
        });

        // å­—é«”å¤§å°æ»‘æ¡¿äº‹ä»¶ç›£è½å™¨
        titleFontSizeInput.addEventListener('input', function() {
            titleFontSizeDisplay.textContent = this.value + 'px';
        });

        contentFontSizeInput.addEventListener('input', function() {
            contentFontSizeDisplay.textContent = this.value + 'px';
        });

        // é¡è‰²é¸æ“‡å™¨äº‹ä»¶ç›£è½å™¨
        themeColorInput.addEventListener('input', function() {
            colorPreview.textContent = this.value.toUpperCase();
            colorPreview.style.color = this.value;
        });

        captureBtn.addEventListener('click', async function() {
            console.log('é–‹å§‹æ“·å–ï¼Œå½±ç‰‡ç‹€æ…‹:', videoPlayer.readyState, 'å­—å¹•æ•¸é‡:', subtitles.length);
            
            if (!videoPlayer.src || videoPlayer.readyState < 2 || subtitles.length === 0) {
                alert('è«‹å…ˆè¼‰å…¥å½±ç‰‡èˆ‡å­—å¹•æª”ï¼Œä¸¦ç­‰å¾…å½±ç‰‡è¼‰å…¥å®Œæˆ');
                return;
            }

            captureBtn.disabled = true;
            captureBtn.textContent = 'â³ æ“·å–ä¸­...';
            outputPreview.innerHTML = '';
            
            // é‡ç½®åœ–ç‰‡ç·¨è™Ÿè¨ˆæ•¸å™¨
            imageCounter = 0;
            
            downloadBtn.style.display = 'none';
            downloadAllZipBtn.style.display = 'none';

            const startTime = timeToSeconds(startTimeInput.value);
            const interval = parseFloat(intervalInput.value);
            const videoDuration = Math.floor(videoPlayer.duration);
            const endTime = videoDuration;
            
            console.log(`å½±ç‰‡ç¸½é•·åº¦: ${videoDuration}ç§’, èµ·å§‹æ™‚é–“: ${startTime}ç§’, é–“éš”: ${interval}ç§’`);
            console.log(`é è¨ˆç”¢ç”Ÿåœ–ç‰‡æ•¸é‡: ${Math.ceil((endTime - startTime) / interval)}å¼µ`);

            if (isNaN(startTime) || isNaN(interval) || interval <= 0 || startTime >= endTime) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„æ™‚é–“èˆ‡é–“éš”');
                captureBtn.disabled = false;
                captureBtn.textContent = 'æ“·å–æˆªåœ–';
                return;
            }
            const images = [];
            let current = startTime;
            const totalImages = Math.ceil((endTime - startTime) / interval);
            let processedImages = 0;

            batchProgress.textContent = `é–‹å§‹æ“·å–ï¼Œé è¨ˆç”¢ç”Ÿ ${totalImages} å¼µåœ–ç‰‡...`;

            while (current < endTime) {
                processedImages++;
                console.log(`è™•ç†æ™‚é–“é»: ${current}ç§’ (${processedImages}/${totalImages})`);
                batchProgress.textContent = `æ“·å–ä¸­... (${processedImages}/${totalImages})`;
                
                const nextTime = Math.min(current + interval, endTime);
                const intervalSubs = subtitles.filter(sub => 
                    sub.start < nextTime && sub.end > current
                );
                const mergedText = intervalSubs.map(sub => sub.text).join('\n');
                
                console.log(`æ™‚é–“å€é–“ ${current}ç§’ - ${nextTime}ç§’ æ‰¾åˆ° ${intervalSubs.length} æ¢å­—å¹•:`, mergedText || 'ç„¡å­—å¹•');

                const canvas = await captureSingleFrame(current);

                if (mode1Radio.checked && mergedText) {
                    renderSubtitleOnCanvas(canvas, mergedText);
                }

                images.push({canvas, time: current, text: mergedText, intervalStart: current, intervalEnd: nextTime});
                current += interval;
            }

            images.forEach(({canvas, time, text, intervalStart, intervalEnd}) => {
                createThumbnail(canvas, time, text, intervalStart, intervalEnd);
            });

            batchProgress.textContent = `âœ… æ“·å–å®Œæˆï¼Œå…± ${images.length} å¼µåœ–ç‰‡ã€‚`;
            downloadBtn.style.display = 'block';
            downloadAllZipBtn.style.display = 'block';
            captureBtn.disabled = false;
            captureBtn.textContent = 'æ“·å–æˆªåœ–';
        });

        function captureSingleFrame(time) {
            return new Promise((resolve) => {
                videoPlayer.onseeked = function() {
                    videoPlayer.onseeked = null;
                    const canvas = document.createElement('canvas');
                    canvas.width = videoPlayer.videoWidth;
                    canvas.height = videoPlayer.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoPlayer, 0, 0);
                    resolve(canvas);
                };
                videoPlayer.currentTime = time;
            });
        }

        function createThumbnail(canvas, time, text, intervalStart, intervalEnd) {
            const thumbContainer = document.createElement('div');
            thumbContainer.className = 'thumbnail-container';
            thumbContainer.style.position = 'relative';
            thumbContainer.style.marginBottom = '50px'; // å¢åŠ åº•éƒ¨é–“è·ä»¥å®¹ç´åºè™Ÿ
            thumbContainer.style.maxWidth = '800px';
            thumbContainer.style.margin = '0 auto 50px auto';
            thumbContainer.style.overflow = 'visible'; // æ”¹ç‚ºvisibleä»¥é¡¯ç¤ºåºè™Ÿ
            thumbContainer.style.borderRadius = '8px';
            thumbContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';

            // æ¨¡å¼3ï¼šæ–‡ç« å¡ç‰‡æ¨£å¼
            if (mode3Radio.checked) {
                createCardStyleThumbnail(thumbContainer, canvas, time, text, intervalStart, intervalEnd);
                outputPreview.appendChild(thumbContainer);
                return;
            }

            const img = document.createElement('img');
            const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
            img.src = dataUrl;
            img.style.width = '100%';
            img.style.maxWidth = '800px';
            img.style.display = 'block';
            thumbContainer.appendChild(img);

            // å¢åŠ åœ–ç‰‡ç·¨è™Ÿ
            imageCounter++;

            thumbContainer.dataset.imageData = dataUrl;
            thumbContainer.dataset.timestamp = secondsToTimeCode(time);
            thumbContainer.dataset.imageNumber = imageCounter.toString().padStart(2, '0');
            
            // æ·»åŠ åºè™Ÿé¡¯ç¤º
            const numberLabel = document.createElement('div');
            numberLabel.className = 'screenshot-number';
            numberLabel.textContent = imageCounter;
            thumbContainer.appendChild(numberLabel);

            thumbContainer.addEventListener('click', function() {
                thumbContainer.classList.toggle('selected');
                thumbContainer.style.border = thumbContainer.classList.contains('selected') ? '3px solid #2196f3' : 'none';
            });

            outputPreview.appendChild(thumbContainer);
        }

        function createCardStyleThumbnail(thumbContainer, canvas, time, text, intervalStart, intervalEnd) {
            thumbContainer.style.backgroundColor = '#ffffff';
            thumbContainer.style.borderRadius = '12px';
            thumbContainer.style.boxShadow = '0 6px 16px rgba(0,0,0,0.12)';
            thumbContainer.style.padding = '0';
            thumbContainer.style.width = '640px';
            thumbContainer.style.maxWidth = '90vw';

            // 1. æ¨™é¡Œå€åŸŸï¼ˆåªåœ¨æœ‰æ¨™é¡Œæ™‚é¡¯ç¤ºï¼‰
            let titleText = cardTitleInput.value.trim();
            
            // å‰µå»ºæ¨™é¡Œå€åŸŸå®¹å™¨ï¼ˆå³ä½¿æ˜¯ç©ºæ¨™é¡Œä¹Ÿå‰µå»ºï¼Œæ–¹ä¾¿å¾ŒçºŒç·¨è¼¯ï¼‰
            const titleSection = document.createElement('div');
            titleSection.className = 'title-section';
            // åˆå§‹åŒ–æ¨£å¼å’Œé¡åˆ¥
            if (titleText) {
                titleSection.classList.add('visible');
                titleSection.style.setProperty('padding', '24px 24px 16px 24px', 'important');
                titleSection.style.setProperty('display', 'block', 'important');
            } else {
                titleSection.classList.add('hidden');
                titleSection.style.setProperty('padding', '0', 'important');
                titleSection.style.setProperty('display', 'none', 'important');
                titleSection.style.setProperty('visibility', 'hidden', 'important');
                titleSection.style.setProperty('opacity', '0', 'important');
                titleSection.style.setProperty('height', '0', 'important');
            }
            
            // å‰µå»ºå¯ç·¨è¼¯çš„æ¨™é¡Œè¼¸å…¥æ¡†
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.value = titleText;
            titleInput.placeholder = 'é»æ“Šè¼¸å…¥æ¨™é¡Œ...';
            titleInput.className = 'card-title-editor';
            titleInput.style.cssText = `
                border: none;
                background: transparent;
                outline: none;
                width: 100%;
                margin: 0 0 8px 0;
                font-size: ${titleFontSizeInput.value}px;
                font-weight: 600;
                color: #1a1a1a;
                line-height: 1.3;
                padding: 4px 0;
                font-family: "Microsoft YaHei", Arial, sans-serif;
            `;
            
            // å‰µå»ºæ©«ç·š
            const underline = document.createElement('div');
            underline.className = 'title-underline';
            underline.style.cssText = `
                height: 3px;
                background-color: ${themeColorInput.value};
                border-radius: 2px;
                transition: width 0.3s ease;
            `;
            
            // åˆå§‹è¨­ç½®æ©«ç·šå¯¬åº¦
            function updateUnderlineWidth() {
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                ctx.font = `600 ${titleFontSizeInput.value}px "Microsoft YaHei", Arial, sans-serif`;
                const titleWidth = ctx.measureText(titleInput.value || titleInput.placeholder).width;
                underline.style.width = titleInput.value ? titleWidth + 'px' : '0px';
            }
            
            // æ¨™é¡Œéš±è—/é¡¯ç¤ºè™•ç†å‡½æ•¸
            function toggleTitleVisibility() {
                const hasTitle = titleInput.value.trim() !== '';
                console.log('æ¨™é¡Œè®Šæ›´æª¢æ¸¬:', hasTitle, 'å€¼:', titleInput.value); // èª¿è©¦ç”¨

                if (hasTitle) {
                    // é¡¯ç¤ºæ¨™é¡Œå€åŸŸ - ä½¿ç”¨ CSS é¡åˆ¥ + inline æ¨£å¼é›™é‡ä¿éšª
                    titleSection.classList.remove('hidden');
                    titleSection.classList.add('visible');
                    titleSection.style.setProperty('display', 'block', 'important');
                    titleSection.style.setProperty('padding', '24px 24px 16px 24px', 'important');
                    titleSection.style.setProperty('visibility', 'visible', 'important');
                    titleSection.style.setProperty('opacity', '1', 'important');
                    updateUnderlineWidth();
                    // èª¿æ•´åœ–ç‰‡å€åŸŸpadding
                    const imageSection = thumbContainer.querySelector('.image-section');
                    if (imageSection) {
                        imageSection.style.padding = '0 24px';
                    }
                } else {
                    // éš±è—æ¨™é¡Œå€åŸŸ - CSS é¡åˆ¥ + inline æ¨£å¼é›™é‡ä¿éšª
                    titleSection.classList.remove('visible');
                    titleSection.classList.add('hidden');
                    titleSection.style.setProperty('display', 'none', 'important');
                    titleSection.style.setProperty('padding', '0', 'important');
                    titleSection.style.setProperty('visibility', 'hidden', 'important');
                    titleSection.style.setProperty('opacity', '0', 'important');
                    titleSection.style.setProperty('height', '0', 'important');
                    underline.style.width = '0px';
                    // èª¿æ•´åœ–ç‰‡å€åŸŸpadding
                    const imageSection = thumbContainer.querySelector('.image-section');
                    if (imageSection) {
                        imageSection.style.padding = '24px 24px 0 24px';
                    }
                }
            }

            // æ¨™é¡Œè¼¸å…¥æ¡†äº‹ä»¶ç›£è½ - å¤šäº‹ä»¶ç¶å®šç¢ºä¿å…¼å®¹æ€§
            titleInput.addEventListener('input', toggleTitleVisibility);
            titleInput.addEventListener('keyup', toggleTitleVisibility);
            titleInput.addEventListener('change', toggleTitleVisibility);
            titleInput.addEventListener('paste', function() {
                // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿è²¼ä¸Šå…§å®¹å·²è™•ç†
                setTimeout(toggleTitleVisibility, 10);
            });
            
            titleInput.addEventListener('focus', function() {
                this.style.backgroundColor = '#f8f9fa';
                this.style.borderRadius = '4px';
                this.style.padding = '4px 8px';
            });
            
            titleInput.addEventListener('blur', function() {
                this.style.backgroundColor = 'transparent';
                this.style.padding = '4px 0';
            });
            
            updateUnderlineWidth();
            
            titleSection.appendChild(titleInput);
            titleSection.appendChild(underline);
            thumbContainer.appendChild(titleSection);

            // 2. åœ–ç‰‡å€åŸŸ
            const imageSection = document.createElement('div');
            imageSection.className = 'image-section';
            // å¦‚æœæ²’æœ‰æ¨™é¡Œï¼Œåœ–ç‰‡å€åŸŸéœ€è¦é ‚éƒ¨padding
            imageSection.style.padding = titleText ? '0 24px' : '24px 24px 0 24px';
            
            const img = document.createElement('img');
            const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
            img.src = dataUrl;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            img.style.display = 'block';
            
            imageSection.appendChild(img);
            thumbContainer.appendChild(imageSection);

            // 3. å­—å¹•å€åŸŸ
            if (text && text.trim()) {
                const subtitleSection = document.createElement('div');
                subtitleSection.style.padding = '20px 24px 24px 24px';
                
                const formattedText = formatSubtitleForCard(text);
                
                const subtitleContent = document.createElement('div');
                subtitleContent.contentEditable = true;
                subtitleContent.style.fontSize = contentFontSizeInput.value + 'px';
                subtitleContent.style.lineHeight = '1.6';
                subtitleContent.style.color = '#444444';
                subtitleContent.style.fontFamily = '"Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", Arial, sans-serif';
                subtitleContent.style.whiteSpace = 'pre-wrap';
                subtitleContent.style.wordBreak = 'break-word';
                subtitleContent.style.overflowWrap = 'break-word';
                subtitleContent.style.border = '1px solid transparent';
                subtitleContent.style.borderRadius = '4px';
                subtitleContent.style.padding = '8px';
                subtitleContent.style.transition = 'border-color 0.2s';
                subtitleContent.style.cursor = 'text';
                subtitleContent.innerHTML = formattedText;
                subtitleContent.title = 'é»æ“Šæ­¤è™•ç·¨è¼¯å­—å¹•å…§å®¹';
                
                subtitleContent.addEventListener('focus', function() {
                    this.style.borderColor = themeColorInput.value;
                    this.style.backgroundColor = '#f9f9f9';
                    this.style.outline = 'none';
                });
                
                subtitleContent.addEventListener('blur', function() {
                    this.style.borderColor = 'transparent';
                    this.style.backgroundColor = 'transparent';
                    thumbContainer.dataset.subtitleText = this.innerText;
                });
                
                subtitleSection.appendChild(subtitleContent);
                
                const updateButton = document.createElement('button');
                updateButton.textContent = 'ğŸ”„ æ›´æ–°å¡ç‰‡';
                updateButton.style.marginTop = '12px';
                updateButton.style.padding = '8px 16px';
                updateButton.style.fontSize = '14px';
                updateButton.style.backgroundColor = themeColorInput.value;
                updateButton.style.color = 'white';
                updateButton.style.border = 'none';
                updateButton.style.borderRadius = '6px';
                updateButton.style.cursor = 'pointer';
                updateButton.style.transition = 'opacity 0.2s';
                
                updateButton.addEventListener('click', function() {
                    updateButton.textContent = 'âœ… å·²æ›´æ–°';
                    setTimeout(() => {
                        updateButton.textContent = 'ğŸ”„ æ›´æ–°å¡ç‰‡';
                    }, 2000);
                });
                
                subtitleSection.appendChild(updateButton);
                thumbContainer.appendChild(subtitleSection);
            }

            // å¢åŠ åœ–ç‰‡ç·¨è™Ÿï¼ˆæ¨¡å¼3ï¼‰
            imageCounter++;

            thumbContainer.dataset.imageData = dataUrl;
            thumbContainer.dataset.timestamp = secondsToTimeCode(time);
            thumbContainer.dataset.subtitleText = text;
            thumbContainer.dataset.cardTitle = titleText || '';
            thumbContainer.dataset.mode = '3';
            thumbContainer.dataset.imageNumber = imageCounter.toString().padStart(2, '0');
            
            // æ·»åŠ åºè™Ÿé¡¯ç¤ºï¼ˆæ¨¡å¼3ï¼‰
            const numberLabel = document.createElement('div');
            numberLabel.className = 'screenshot-number';
            numberLabel.textContent = imageCounter;
            thumbContainer.appendChild(numberLabel);

            thumbContainer.addEventListener('click', function() {
                thumbContainer.classList.toggle('selected');
                thumbContainer.style.border = thumbContainer.classList.contains('selected') ? '3px solid ' + themeColorInput.value : 'none';
            });
        }

        function formatSubtitleForCard(text) {
            if (!text) return '';
            const cleanText = text.replace(/\n+/g, '').trim();
            const sentences = cleanText.split(/([ã€‚ï¼ï¼Ÿ])/).filter(s => s.trim());
            let paragraphs = [];
            let currentParagraph = '';
            
            for (let i = 0; i < sentences.length; i += 2) {
                const sentence = sentences[i] + (sentences[i + 1] || '');
                
                if (currentParagraph.length + sentence.length > 120) {
                    if (currentParagraph) {
                        paragraphs.push(currentParagraph.trim());
                    }
                    currentParagraph = sentence;
                } else {
                    currentParagraph += sentence;
                }
            }
            
            if (currentParagraph.trim()) {
                paragraphs.push(currentParagraph.trim());
            }
            
            return paragraphs.join('\n\n');
        }

        function parseSrt(data) {
            console.log('åŸå§‹å­—å¹•è³‡æ–™é•·åº¦:', data.length);
            return data.trim().split('\n\n').map(block => {
                const lines = block.split('\n');
                if (lines.length < 3) return null;
                const time = lines[1].split(' --> ');
                return {
                    start: timeToSeconds(time[0].replace(',', '.')),
                    end: timeToSeconds(time[1].replace(',', '.')),
                    text: lines.slice(2).join('\n')
                };
            }).filter(Boolean);
        }

        function timeToSeconds(timeString) {
            const parts = timeString.split(/[:,.]/);
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]) + (parseInt(parts[3] || 0) / 1000);
        }

        function secondsToTimeCode(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}-${m}-${s}`;
        }

        function renderSubtitleOnCanvas(canvas, text) {
            // æ¨¡å¼1å­—å¹•æ¸²æŸ“åŠŸèƒ½ï¼ˆç°¡åŒ–ç‰ˆï¼‰
            if (!text) return;
            const ctx = canvas.getContext('2d');
            ctx.font = 'bold 24px "Microsoft YaHei", Arial, sans-serif';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText(text.substring(0, 50), canvas.width / 2, canvas.height - 50);
        }

        // ä¸‹è¼‰é¸ä¸­åœ–ç‰‡åŠŸèƒ½
        downloadBtn.addEventListener('click', function() {
            const selectedThumbs = document.querySelectorAll('.thumbnail-container.selected');
            if (selectedThumbs.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦ä¸‹è¼‰çš„åœ–ç‰‡');
                return;
            }
            
            if (selectedThumbs.length === 1) {
                // å–®å¼µåœ–ç‰‡ç›´æ¥ä¸‹è¼‰
                const thumb = selectedThumbs[0];
                const imageNumber = thumb.dataset.imageNumber;
                const mode = thumb.dataset.mode || '1';
                const filename = generateFileName(imageNumber);
                
                if (mode === '3') {
                    // æ¨¡å¼3éœ€è¦è½‰æ›DOMç‚ºåœ–ç‰‡
                    convertCardToImage(thumb).then(dataUrl => {
                        downloadImage(dataUrl, filename);
                    });
                } else {
                    // å…¶ä»–æ¨¡å¼ç›´æ¥ä¸‹è¼‰
                    const imageData = thumb.dataset.imageData;
                    downloadImage(imageData, filename);
                }
            } else {
                // å¤šå¼µåœ–ç‰‡æ‰“åŒ…æˆZIP
                downloadSelectedAsZip(selectedThumbs);
            }
        });
        
        // ä¸€éµæ‰“åŒ…å…¨éƒ¨åœ–ç‰‡åŠŸèƒ½
        downloadAllZipBtn.addEventListener('click', function() {
            const allThumbs = document.querySelectorAll('.thumbnail-container');
            if (allThumbs.length === 0) {
                alert('æ²’æœ‰åœ–ç‰‡å¯ä»¥æ‰“åŒ…');
                return;
            }
            downloadSelectedAsZip(allThumbs, true);
        });
        
        // ç”Ÿæˆæª”åçš„å‡½æ•¸
        function generateFileName(imageNumber) {
            const baseName = subtitleFileName || videoFileName || 'image';
            return `${baseName}_${imageNumber}.jpg`;
        }

        // å–®å¼µåœ–ç‰‡ä¸‹è¼‰å‡½æ•¸
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // å°‡æ¨¡å¼3å¡ç‰‡è½‰æ›ç‚ºåœ–ç‰‡çš„å‡½æ•¸
        function convertCardToImage(cardElement) {
            return new Promise((resolve) => {
                // ä½¿ç”¨ html2canvas æˆ–è€…æ‰‹å‹•å‰µå»ºcanvas
                // é€™è£¡æˆ‘å€‘ç”¨æ›´ç°¡å–®çš„æ–¹æ³•ï¼šå‰µå»ºä¸€å€‹æ–°çš„canvasä¾†é‡ç¹ªå¡ç‰‡
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è¨ˆç®—å¯¦éš›éœ€è¦çš„é«˜åº¦
                const hasTitle = cardElement.querySelector('.card-title-editor').value.trim() !== '';
                const titleHeight = hasTitle ? 72 : 0; // æ¨™é¡Œå€åŸŸé«˜åº¦
                const imageHeight = Math.round((640-48) * (9/16)); // 16:9 æ¯”ä¾‹çš„åœ–ç‰‡é«˜åº¦
                const subtitleText = cardElement.dataset.subtitleText || '';
                
                // è¨ˆç®—å­—å¹•æ–‡å­—çš„è¡Œæ•¸
                const tempCtx = document.createElement('canvas').getContext('2d');
                tempCtx.font = '16px Microsoft YaHei, Arial, sans-serif';
                const maxWidth = 592; // 640 - 48 (padding)
                const lines = wrapText(tempCtx, subtitleText, maxWidth);
                const textHeight = lines.length * 24 + 40; // è¡Œé«˜24px + ä¸Šä¸‹é–“è·
                
                // è¨­å®šç•«å¸ƒå¤§å°
                canvas.width = 640;
                canvas.height = titleHeight + imageHeight + textHeight + 48; // 48pxç¸½padding
                
                // å¡«å……ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                let currentY = 0;
                
                // æ·»åŠ æ¨™é¡Œï¼ˆå¦‚æœæœ‰ï¼‰
                const titleInput = cardElement.querySelector('.card-title-editor');
                if (hasTitle && titleInput && titleInput.value.trim()) {
                    currentY += 24; // é ‚éƒ¨padding
                    
                    ctx.fillStyle = '#1a1a1a';
                    ctx.font = 'bold 22px Microsoft YaHei, Arial, sans-serif';
                    ctx.fillText(titleInput.value, 24, currentY + 22);
                    
                    // æ·»åŠ æ©«ç·š
                    ctx.fillStyle = '#1877f2';
                    const titleWidth = ctx.measureText(titleInput.value).width;
                    ctx.fillRect(24, currentY + 30, titleWidth, 3);
                    
                    currentY += 48; // æ¨™é¡Œ + æ©«ç·š + é–“è·
                }
                
                // ç²å–å¡ç‰‡ä¸­çš„åœ–ç‰‡
                const img = cardElement.querySelector('img');
                if (img) {
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        // ç¹ªè£½åœ–ç‰‡åˆ°canvas
                        const imgY = hasTitle ? currentY : 24;
                        ctx.drawImage(tempImg, 24, imgY, 640-48, imageHeight);
                        
                        // æ·»åŠ å­—å¹•æ–‡å­—
                        if (subtitleText) {
                            ctx.fillStyle = '#444444';
                            ctx.font = '16px Microsoft YaHei, Arial, sans-serif';
                            
                            const startY = imgY + imageHeight + 40;
                            
                            lines.forEach((line, index) => {
                                ctx.fillText(line, 24, startY + (index * 24));
                            });
                        }
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    };
                    tempImg.src = img.src;
                } else {
                    // å¦‚æœæ²’æœ‰åœ–ç‰‡ï¼Œåªç¹ªè£½æ–‡å­—
                    if (subtitleText) {
                        ctx.fillStyle = '#444444';
                        ctx.font = '16px Microsoft YaHei, Arial, sans-serif';
                        
                        const startY = hasTitle ? currentY + 40 : 64;
                        
                        lines.forEach((line, index) => {
                            ctx.fillText(line, 24, startY + (index * 24));
                        });
                    }
                    resolve(canvas.toDataURL('image/jpeg', 0.92));
                }
            });
        }
        
        // æ–‡å­—æ›è¡Œè¼”åŠ©å‡½æ•¸
        function wrapText(ctx, text, maxWidth) {
            const words = text.split('');
            const lines = [];
            let currentLine = '';
            
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine + words[i];
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        // ZIPæ‰“åŒ…ä¸‹è¼‰å‡½æ•¸
        function downloadSelectedAsZip(thumbs, isAll = false) {
            const zip = new JSZip();
            const prefix = isAll ? 'å…¨éƒ¨åœ–ç‰‡' : 'é¸ä¸­åœ–ç‰‡';
            let processedCount = 0;
            const totalCount = thumbs.length;
            
            Array.from(thumbs).forEach((thumb, index) => {
                const imageNumber = thumb.dataset.imageNumber;
                const mode = thumb.dataset.mode || '1';
                const filename = generateFileName(imageNumber).replace('.jpg', ''); // ç§»é™¤.jpgå› ç‚ºå¾Œé¢æœƒåŠ 
                
                if (mode === '3') {
                    // æ¨¡å¼3éœ€è¦è½‰æ›DOMç‚ºåœ–ç‰‡
                    convertCardToImage(thumb).then(dataUrl => {
                        const base64Data = dataUrl.split(',')[1];
                        zip.file(`${filename}.jpg`, base64Data, {base64: true});
                        processedCount++;
                        
                        if (processedCount === totalCount) {
                            generateAndDownloadZip();
                        }
                    });
                } else {
                    // å…¶ä»–æ¨¡å¼ç›´æ¥ä½¿ç”¨åœ–ç‰‡æ•¸æ“š
                    const imageData = thumb.dataset.imageData;
                    if (imageData) {
                        const base64Data = imageData.split(',')[1];
                        zip.file(`${filename}.jpg`, base64Data, {base64: true});
                    }
                    processedCount++;
                    
                    if (processedCount === totalCount) {
                        generateAndDownloadZip();
                    }
                }
            });
            
            function generateAndDownloadZip() {
                zip.generateAsync({type: 'blob'}).then(function(content) {
                    const link = document.createElement('a');
                    const baseName = subtitleFileName || videoFileName || 'images';
                    link.download = `${baseName}_${prefix}_${new Date().toISOString().slice(0, 10)}.zip`;
                    link.href = URL.createObjectURL(content);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                });
            }
        }

        console.log('âœ… æ¨¡å¼3åŠŸèƒ½å·²å®Œæ•´è¼‰å…¥ï¼');
    </script>
</body>
</html>